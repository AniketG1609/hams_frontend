<div class="flex min-h-screen">
  <!-- Doctor Sidebar (similar to your appointments page) -->
  <aside class="fixed overflow-y-auto w-64 bg-white shadow-lg p-6 shrink-0 h-[90%]">
    <div class="px-6 py-8 border-b border-gray-200">
      <div class="text-2xl font-bold text-blue-600 flex items-center gap-2">‚öï MediCare</div>
    </div>
    <ul class="mt-6 space-y-1">
      <li>
        <a
          [routerLink]="['/doctor/dashboard']"
          class="flex items-center gap-3 px-6 py-3 font-medium text-gray-600 hover:bg-gray-100 hover:text-blue-600 hover:border-l-4 hover:border-blue-600 transition"
          >üìä Dashboard</a
        >
      </li>
      <li>
        <a
          [routerLink]="['/doctor/appointments']"
          class="flex items-center gap-3 px-6 py-3 font-medium text-gray-600 hover:bg-gray-100 hover:text-blue-600 hover:border-l-4 hover:border-blue-600 transition"
          >üìÖ Appointments</a
        >
      </li>
      <li>
        <a
          [routerLink]="['/doctor/patients']"
          class="flex items-center gap-3 px-6 py-3 font-medium text-gray-600 hover:bg-gray-100 hover:text-blue-600 hover:border-l-4 hover:border-blue-600 transition"
          >üë• Patients</a
        >
      </li>

      <li>
        <a
          [routerLink]="['/doctor/availability']"
          class="flex items-center gap-3 px-6 py-3 font-medium text-gray-600 hover:bg-gray-100 hover:text-blue-600 hover:border-l-4 hover:border-blue-600 transition"
          >‚è∞ Availability</a
        >
      </li>
      <li>
        <a
          [routerLink]="['/doctor/medical-records']"
          class="flex items-center gap-3 px-6 py-3 font-medium text-blue-600 bg-blue-50 border-l-4 border-blue-600"
          >üìã Medical Records</a
        >
      </li>

      <li>
        <button
          (click)="logout()"
          class="flex items-center gap-3 px-6 py-3 font-medium text-red-600 hover:bg-gray-100 hover:border-l-4 hover:border-red-600 rounded-l w-full text-left"
        >
          üö™ Logout
        </button>
      </li>
    </ul>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 ml-64 p-6">
    <!-- Header -->
    <div class="bg-white rounded-xl shadow p-6 mb-6">
      <div class="flex justify-between items-start mb-6">
        <div>
          <h1 class="text-2xl font-semibold text-gray-800">Patient Medical Records</h1>
          <div class="text-gray-500 text-sm mt-1">
            <a [routerLink]="['/doctor/dashboard']" class="text-blue-600">Dashboard</a> / Medical
            Records
          </div>
        </div>
        <div class="text-right">
          <p class="text-gray-600">Dr. {{ doctor?.doctorName }}</p>
          <p class="text-sm text-gray-500">{{ doctor?.specialization }}</p>
        </div>
      </div>

      <!-- Filters -->
      <div class="flex flex-wrap gap-4 mb-4">
        <div class="relative flex-1 min-w-[250px]">
          <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">üîç</span>
          <input
            type="text"
            placeholder="Search by patient name, diagnosis, or reason..."
            [(ngModel)]="searchTerm"
            (input)="filterRecords()"
            class="w-full border-2 border-gray-300 rounded-lg py-2 px-10 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-200 transition"
          />
        </div>

        <!-- Patient Filter -->
        <select
          [(ngModel)]="patientFilter"
          (change)="filterRecords()"
          class="border-2 border-gray-300 rounded-lg py-2 px-3 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-200 transition"
        >
          <option value="">All Patients</option>
          <option *ngFor="let patient of uniquePatients" [value]="patient">
            {{ patient }}
          </option>
        </select>

        <!-- Date Filter -->
        <select
          [(ngModel)]="dateFilter"
          (change)="filterRecords()"
          class="border-2 border-gray-300 rounded-lg py-2 px-3 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-200 transition"
        >
          <option value="all">All Time</option>
          <option value="today">Today</option>
          <option value="week">Past Week</option>
          <option value="month">Past Month</option>
          <option value="year">Past Year</option>
        </select>

        <button
          (click)="clearFilters()"
          class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition"
        >
          Clear Filters
        </button>
      </div>

      <!-- Stats -->
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
          <div class="text-blue-600 text-sm font-semibold">Total Records</div>
          <div class="text-2xl font-bold text-blue-700">{{ medicalRecords.length }}</div>
        </div>
        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
          <div class="text-green-600 text-sm font-semibold">Unique Patients</div>
          <div class="text-2xl font-bold text-green-700">{{ uniquePatients.length }}</div>
        </div>
        <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
          <div class="text-purple-600 text-sm font-semibold">Filtered Records</div>
          <div class="text-2xl font-bold text-purple-700">{{ filteredRecords.length }}</div>
        </div>
      </div>
    </div>

    <!-- Medical Records List -->
    <div class="bg-white rounded-xl shadow">
      @if (isLoading) {
      <div class="text-center py-10 text-xl text-gray-500">
        <div
          class="animate-spin inline-block w-8 h-8 border-4 border-t-blue-600 border-gray-200 rounded-full"
        ></div>
        <p class="mt-2">Loading medical records...</p>
      </div>
      } @else {
      <div class="p-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">
          Consultation History ({{ filteredRecords.length }} records)
        </h2>

        <div class="space-y-6">
          @for (record of filteredRecords; track record.recordId) {
          <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md transition">
            <div class="flex justify-between items-start mb-4">
              <div class="flex items-center gap-4 flex-1">
                <div
                  class="w-16 h-16 bg-linear-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-lg"
                >
                  {{ getPatientInitials(record.patientName) }}
                </div>
                <div class="flex-1">
                  <div class="flex items-center gap-3 mb-2">
                    <h3 class="font-semibold text-gray-800 text-lg">{{ record.patientName }}</h3>
                    <span
                      class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-medium"
                    >
                      Patient
                    </span>
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3">
                    <div class="text-sm text-gray-600">
                      <span class="font-medium">Date:</span>
                      {{ record.createdAt | date : 'mediumDate' }}
                    </div>
                    <div class="text-sm text-gray-600">
                      <span class="font-medium">Time:</span>
                      {{ record.createdAt | date : 'shortTime' }}
                    </div>
                    <div class="text-sm text-gray-600">
                      <span class="font-medium">Visit Reason:</span>
                      {{ record.reason || 'Not specified' }}
                    </div>
                  </div>

                  @if (record.diagnosis) {
                  <div class="mb-3">
                    <span class="font-medium text-gray-700 text-sm">Diagnosis:</span>
                    <span class="text-gray-600 text-sm ml-2">{{ record.diagnosis }}</span>
                  </div>
                  } @if (record.notes) {
                  <div class="mb-3">
                    <span class="font-medium text-gray-700 text-sm">Notes:</span>
                    <span class="text-gray-600 text-sm ml-2 line-clamp-2">{{ record.notes }}</span>
                  </div>
                  }
                </div>
              </div>
            </div>

            <!-- @if (hasPrescriptions(record)) {
            <div class="border-t border-gray-200 pt-4 mb-4">
              <h4 class="font-medium text-gray-700 mb-2 text-sm">
                Prescriptions ({{ record.prescriptions.length }})
              </h4>
              <div class="space-y-1">
                @for (prescription of record.prescriptions; track prescription.prescriptionId) {
                <div class="flex justify-between items-center bg-gray-50 p-2 rounded text-sm">
                  <div>
                    <span class="font-semibold text-gray-800">{{
                      prescription.medicationName
                    }}</span>
                    <span class="text-gray-600 ml-2">
                      {{ prescription.dosage }} ‚Ä¢ {{ prescription.instructions || 'As directed' }}
                    </span>
                  </div>
                </div>
                }
              </div>
            </div>
            } -->

            <div class="flex gap-2 pt-4 border-t border-gray-200">
              <button
                (click)="viewRecordDetails(record)"
                class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-500 transition text-sm"
              >
                View Full Details
              </button>
            </div>
          </div>
          } @if (filteredRecords.length === 0) {
          <div class="text-center py-12 text-gray-500">
            <div class="text-6xl mb-4">üìã</div>
            <h3 class="text-xl font-semibold mb-2">No medical records found</h3>
            <p>Medical records will appear here after you complete consultations with patients.</p>
            @if (searchTerm || patientFilter || dateFilter !== 'all') {
            <p class="mt-2">Try adjusting your filters to see more results.</p>
            }
          </div>
          }
        </div>
      </div>
      }
    </div>
  </main>
</div>

<!-- Medical Record Details Modal (Same as patient version but adapted for doctor) -->
@if (showRecordModal && selectedRecord) {
<div class="fixed inset-0 backdrop-blur-xs bg-opacity-50 flex items-center justify-center z-50 p-4">
  <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
    <div class="p-6 border-b border-gray-200">
      <div class="flex justify-between items-center">
        <h3 class="text-xl font-semibold text-gray-800">Consultation Details</h3>
        <button (click)="closeRecordModal()" class="text-gray-500 hover:text-gray-700 text-2xl">
          √ó
        </button>
      </div>
      <p class="text-gray-600 mt-1">
        Consultation with {{ selectedRecord.patientName }} on
        {{ selectedRecord.createdAt | date : 'fullDate' }} at
        {{ selectedRecord.createdAt | date : 'shortTime' }}
      </p>
    </div>

    <div class="p-6 space-y-6">
      <!-- Patient Information -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <h4 class="font-semibold text-gray-700 mb-2">Patient Information</h4>
          <div class="space-y-2 text-sm">
            <div class="flex items-center gap-3">
              <div
                class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold"
              >
                {{ getPatientInitials(selectedRecord.patientName) }}
              </div>
              <div>
                <p class="font-medium">{{ selectedRecord.patientName }}</p>
                <p class="text-gray-500">Patient ID: {{ selectedRecord.patientId }}</p>
              </div>
            </div>
          </div>
        </div>

        <div>
          <h4 class="font-semibold text-gray-700 mb-2">Consultation Information</h4>
          <div class="space-y-1 text-sm">
            <p>
              <span class="font-medium">Date & Time:</span>
              {{ selectedRecord.createdAt | date : 'medium' }}
            </p>
            <p>
              <span class="font-medium">Reason:</span>
              {{ selectedRecord.reason || 'Not specified' }}
            </p>
            @if (selectedRecord.diagnosis) {
            <p><span class="font-medium">Diagnosis:</span> {{ selectedRecord.diagnosis }}</p>
            }
          </div>
        </div>
      </div>

      <!-- Doctor's Notes -->
      @if (selectedRecord.notes) {
      <div>
        <h4 class="font-semibold text-gray-700 mb-2">Consultation Notes</h4>
        <div class="bg-gray-50 p-4 rounded-lg">
          <p class="text-gray-700 whitespace-pre-line">{{ selectedRecord.notes }}</p>
        </div>
      </div>
      }
    </div>

    <div class="p-6 border-t border-gray-200 flex gap-3">
      <button
        (click)="closeRecordModal()"
        class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg hover:bg-gray-300 transition font-medium"
      >
        Close
      </button>
    </div>
  </div>
</div>
}
